<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>&#x9700;&#x6c42;&#x5206;&#x6790;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <div style="text-align:center;font-size:2em;font-weight:bold">中国科学技术大学计算机学院</div>
<div style="text-align:center;font-size:2em;font-weight:bold">《数据库系统实验报告》</div>
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\logo.png" style="zoom: 50%;" />
<div style="display: flex;flex-direction: column;align-items: center;font-size:2em">
<div>
<p>实验题目：图书馆信息管理系统</p>
<p>学生姓名：付斯珂</p>
<p>学生学号：PB21061224</p>
<p>完成时间：2024年6月20日</p>
</div>
</div>
<div style="page-break-after:always"></div>
<h2 id="需求分析">需求分析</h2>
<blockquote>
<p>描述应用场景，分析所需功能</p>
</blockquote>
<p>应用于图书馆管理。
主要功能：</p>
<ul>
<li>用户分为普通用户和管理员</li>
<li>用户登录、注册</li>
<li>查看、修改个人信息</li>
<li>根据图书名关键字查询图书</li>
<li>借书、还书</li>
<li>查看个人所有的借书历史记录，和未还书记录</li>
<li>图书管理员操作：删除用户（自动归还该用户所有的借书），下架和上架书籍</li>
</ul>
<h2 id="总体设计">总体设计</h2>
<h4 id="系统模块结构">系统模块结构</h4>
<blockquote>
<p>分为前端和后端两大模块</p>
</blockquote>
<p><strong>前端：</strong> <strong>PyQt5</strong> + <strong>QtDesigner</strong> 开发。QtDesigner设计每个窗口UI界面，导出.ui文件。<code>pyuic5 -o xxx.py xxx.ui</code>将.ui文件转化为.py文件。之后在后端import 前端的.py文件。</p>
<blockquote>
<p>前端文件：
|  <a href="http://borrow.py">borrow.py</a>
│  login_start.py
│  <a href="http://manager.py">manager.py</a>
│  personal_information.py
│  return_book.py
│  <a href="http://ui.py">ui.py</a>
│  <a href="http://welcome.py">welcome.py</a>
|  image_rc.py</p>
</blockquote>
<p><strong>后端：</strong> 全部功能实现在 <code>backend.py</code>中。对每个窗口，后端绑定功能部件对应功能：执行mySQL数据库操作或者前端操作。</p>
<h4 id="系统工作流程">系统工作流程</h4>
<pre><code class="language-mermaid">    flowchart TD
        A[登录]
        B(登录失败)
        C(登录成功)
        D[注册]
        E(注册成功)
        F(注册失败)
        A --Reader表中未查询到对应账号密码--&gt; B
        A --&gt; C
        D --&gt; E
        D --Reader表中已有该账号--&gt; F
        G[导航页面]
        B &amp; C &amp; E &amp; F --&gt; G
        H[个人信息] 
        I[借书]
        J[还书]
        K[图书管理员操作]
        G --&gt; H &amp; I &amp; J
        G --当前用户为管理员--&gt;K
        L[用户管理]
        M[书籍管理]
        K -.-&gt; L &amp; M
</code></pre>
<h4 id="数据库设计">数据库设计</h4>
<ol>
<li>ER图
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\ER.jpg" alt="1719055075643"></li>
<li>存储过程
修改读者号。输入参数为旧读者号reader_ID_from和新读者号reader_ID_to。
需同时更改Reader表和Borrow表。</li>
</ol>
<pre><code class="language-sql">DELIMITER <span class="hljs-operator">/</span><span class="hljs-operator">/</span>
<span class="hljs-keyword">drop</span> <span class="hljs-keyword">procedure</span> if <span class="hljs-keyword">exists</span> updateReaderID;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">procedure</span> updateReaderID(reader_ID_from <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>), reader_ID_to <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>))
<span class="hljs-keyword">BEGIN</span>
<span class="hljs-keyword">declare</span> state <span class="hljs-type">int</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">declare</span> CONTINUE HANDLER <span class="hljs-keyword">for</span> <span class="hljs-keyword">SQLEXCEPTION</span> <span class="hljs-keyword">set</span> state <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- start transaction;</span>
<span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> Borrow
    <span class="hljs-keyword">drop</span> <span class="hljs-keyword">Constraint</span> FK_Borrow_reader;

<span class="hljs-keyword">update</span> Borrow 
<span class="hljs-keyword">set</span> reader_ID <span class="hljs-operator">=</span> reader_ID_to
<span class="hljs-keyword">where</span> reader_ID <span class="hljs-operator">=</span> reader_ID_from;

<span class="hljs-keyword">update</span> Reader 
<span class="hljs-keyword">set</span> rid <span class="hljs-operator">=</span> reader_ID_to
<span class="hljs-keyword">where</span> rid <span class="hljs-operator">=</span> reader_ID_from;

<span class="hljs-keyword">END</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span>
DELIMITER ;
</code></pre>
<ol start="3">
<li>函数
计算一本书被借阅的总次数。返回值为借阅次数。</li>
</ol>
<pre><code class="language-sql">DELIMITER <span class="hljs-operator">/</span><span class="hljs-operator">/</span>
<span class="hljs-keyword">drop</span> <span class="hljs-keyword">function</span> if <span class="hljs-keyword">exists</span> getBorrowTimes;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">function</span> getBorrowTimes(rid <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>))
<span class="hljs-keyword">returns</span> <span class="hljs-type">int</span>
<span class="hljs-keyword">reads</span> <span class="hljs-keyword">sql</span> data
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> BorrowTimes <span class="hljs-type">INT</span>; <span class="hljs-comment">-- 声明变量</span>
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">INTO</span> BorrowTimes <span class="hljs-keyword">FROM</span> Borrow <span class="hljs-keyword">WHERE</span> Borrow.reader_ID <span class="hljs-operator">=</span> rid;
    <span class="hljs-keyword">RETURN</span> BorrowTimes;
<span class="hljs-keyword">END</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span>
DELIMITER ;
</code></pre>
<ol start="4">
<li>触发器
当读者借了一本书，Borrow表中新填一条记录时，触发器将对应被借的书的状态修改为已被借出，借阅次数也加一。</li>
</ol>
<pre><code class="language-sql">DELIMITER <span class="hljs-operator">/</span><span class="hljs-operator">/</span>
<span class="hljs-keyword">drop</span> <span class="hljs-keyword">trigger</span> if <span class="hljs-keyword">exists</span> borrowBook1;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">trigger</span> borrowBook1 after <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">on</span> Borrow <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-type">row</span>
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-comment">-- 更改Book表中的bstatus</span>
    <span class="hljs-keyword">update</span> Book <span class="hljs-keyword">set</span> bstatus <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">where</span> bid <span class="hljs-operator">=</span> new.book_ID;
<span class="hljs-keyword">END</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span>
DELIMITER ;

DELIMITER <span class="hljs-operator">/</span><span class="hljs-operator">/</span>
<span class="hljs-keyword">drop</span> <span class="hljs-keyword">trigger</span> if <span class="hljs-keyword">exists</span> borrowBook2;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">trigger</span> borrowBook2 after <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">on</span> Borrow <span class="hljs-keyword">for</span> <span class="hljs-keyword">each</span> <span class="hljs-type">row</span>
<span class="hljs-keyword">BEGIN</span>
   <span class="hljs-comment">-- 更改Book表中的borrow_Times</span>
    <span class="hljs-keyword">update</span> Book <span class="hljs-keyword">set</span> borrow_Times<span class="hljs-operator">=</span>borrow_Times<span class="hljs-operator">+</span><span class="hljs-number">1</span> <span class="hljs-keyword">where</span> bid <span class="hljs-operator">=</span> new.book_ID;
<span class="hljs-keyword">END</span> <span class="hljs-operator">/</span><span class="hljs-operator">/</span>
DELIMITER ;
</code></pre>
<h2 id="核心代码解析可改名为对应模块如后端实现">核心代码解析（可改名为对应模块，如后端实现）</h2>
<h4 id="仓库地址">仓库地址</h4>
<blockquote>
<p>建议使用github、gitlab、gitee等代码托管网站进行开发，并在<strong>实验验收结束前</strong>设置为<strong>private</strong>，结束后改为<strong>public</strong></p>
</blockquote>
<h4 id="目录">目录</h4>
<blockquote>
<p>使用tree命令获取文件结构，并在文件名后用 &quot;-------注释&quot; 解释文件功能</p>
</blockquote>
<p>D:.
├─report                -------实验报告
│  │  实验报告.pdf
│  │
│  └─image              -------报告中的图片
│          1.png
│          10.png
│          11.png
│          12.png
│          13.png
│          14.png
│          15.png
│          16.png
│          17.png
│          18.png
│          19.png
│          2.png
│          20.png
│          21.png
│          22.png
│          3.png
│          4.png
│          5.png
│          6.png
│          7.png
│          8.png
│          9.png
│          ER.png
│          logo.png
│
└─src
│  <a href="http://backend.py">backend.py</a>               -------后端实现
│  <a href="http://borrow.py">borrow.py</a>                -------前端：借书窗口
│  image_rc.py              -------前端：图片资源
│  login_start.py           -------前端：登录窗口
│  <a href="http://manager.py">manager.py</a>               -------前端：管理员操作窗口
│  personal_information.py  -------前端：个人信息窗口
│  return_book.py           -------前端：还书窗口
│  <a href="http://welcome.py">welcome.py</a>               -------前端：导航窗口
│
├─MySQL                     -------数据库文件
│      create_table.sql     -------建表
│      procedure1.sql       -------存储过程
│      procedure2.sql       -------函数
│      test_cases.sql       -------插入测试用例
│      trigger1.sql         -------触发器
│
├─ui                        -------前端设计ui文件，用于转换为python文件
│      BasicInformation.ui
│      borrow.ui
│      image.qrc
│      login.ui
│      manager.ui
│      personal_information.ui
│      return.ui
│      temp.ui
│      Welcome.ui
│
├─user_pics               -------用户头像
│      111.jpg
│      default.jpg        -------默认头像
│      R001.jpg
│      R002.jpg
│      R003.jpg
│      R004.jpg
│      R005.jpg
│      R006.jpg
│
└─__pycache__            -------python编译后的文件
borrow.cpython-312.pyc
image_rc.cpython-312.pyc
login.cpython-312.pyc
login_start.cpython-312.pyc
manager.cpython-312.pyc
personal_information.cpython-312.pyc
return_book.cpython-312.pyc
Welcome.cpython-312.pyc</p>
<h4 id="sql">sql</h4>
<p><code>create_table.sql</code>建表。</p>
<pre><code class="language-sql">use library;
<span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> if <span class="hljs-keyword">exists</span> Borrow;
<span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> if <span class="hljs-keyword">exists</span> Book;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> Book(
bid <span class="hljs-type">char</span>(<span class="hljs-number">8</span>) <span class="hljs-keyword">Primary</span> Key,
bname <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, 
author <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>), 
price <span class="hljs-type">float</span>, 
bstatus <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>, <span class="hljs-comment">-- 1可借 0借出</span>
);

<span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> if <span class="hljs-keyword">exists</span> Reader;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> Reader(
rid <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>), 
rpassword <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>),
rname <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>), 
age <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>, 
address <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
<span class="hljs-keyword">Constraint</span> PK_Reader <span class="hljs-keyword">Primary</span> Key(rid)
);

<span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> if <span class="hljs-keyword">exists</span> Manager;
<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> Manager(
mid <span class="hljs-type">char</span>(<span class="hljs-number">20</span>), 
mpassword <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>),
mname <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>), 
age <span class="hljs-type">int</span>, 
address <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>),
<span class="hljs-keyword">Constraint</span> PK_Reader <span class="hljs-keyword">Primary</span> Key(mid)
);

<span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> Borrow( <span class="hljs-comment">-- 借书信息</span>
book_ID <span class="hljs-type">char</span>(<span class="hljs-number">8</span>), 
reader_ID <span class="hljs-type">char</span>(<span class="hljs-number">20</span>), 
borrow_Date <span class="hljs-type">date</span>, 
return_Date <span class="hljs-type">date</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
<span class="hljs-keyword">Constraint</span> PK_Borrow <span class="hljs-keyword">Primary</span> Key(book_ID, reader_ID, borrow_Date),
<span class="hljs-keyword">Constraint</span> FK_Borrow_Book <span class="hljs-keyword">Foreign</span> Key(book_ID) <span class="hljs-keyword">References</span> Book(bid) <span class="hljs-keyword">on</span> <span class="hljs-keyword">delete</span> cascade,
<span class="hljs-keyword">Constraint</span> FK_Borrow_reader <span class="hljs-keyword">Foreign</span> Key(reader_ID) <span class="hljs-keyword">References</span> Reader(rid) <span class="hljs-keyword">on</span> <span class="hljs-keyword">delete</span> cascade
);
</code></pre>
<h4 id="front-end">front-end</h4>
<p>QtDesigner设计好界面后一系列操作自动生成，已经在“总体设计-系统模块设计-前端”中讲解。</p>
<h4 id="back-end">back-end</h4>
<p><code>backend.py</code>实现
一个类 <code>class</code>对应一个窗口。每个类都有类似的方法，如 <code>execute</code>事务游标执行sql语句，<code>error_input</code>弹出错误提示框，<code>bind_up</code>绑定信号和槽函数。但根据每个窗口负责的不同功能，方法有所不同。</p>
<h5 id="连接数据库">连接数据库</h5>
<p><code>MySQLdb.connect</code>连接数据库。<code>status</code>为0表示连接成功，为1表示连接失败。
实例化所有窗口类。显示login窗口。</p>
<pre><code class="language-python"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:
	<span class="hljs-keyword">global</span> db
	<span class="hljs-keyword">try</span>:
		db = MySQLdb.connect(host=<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>, port=<span class="hljs-number">3306</span>, user=<span class="hljs-string">&#x27;root&#x27;</span>, passwd=<span class="hljs-string">&#x27;Fsk20030422&#x27;</span>,db=<span class="hljs-string">&quot;library&quot;</span>, charset=<span class="hljs-string">&#x27;utf8&#x27;</span>)
		<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Connected successfully!&quot;</span>)
		status = <span class="hljs-number">0</span>
	<span class="hljs-keyword">except</span>:
		status = <span class="hljs-number">1</span>
		<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Failed to connect the database!&quot;</span>)

	app = QtWidgets.QApplication(sys.argv)

	LoginWindow = LoginWindow()
	TestWindow = TestWindow()
	PersonnalInformationWindow = PersonnalInformationWindow()
	BorrowWindow = BorrowWindow()
	ReturnWindow = ReturnWindow()
	ManagerWindow = ManagerWindow()

	welcome_window = WelcomeWindow(TestWindow, PersonnalInformationWindow, BorrowWindow, ReturnWindow, ManagerWindow)
	LoginWindow.welcome_window = welcome_window
	LoginWindow.show()

	sys.exit(app.exec_())
</code></pre>
<h5 id="登录窗口">登录窗口</h5>
<p>运行程序，首先出现的是登录窗口。用户可以输入账号和密码登录，也可以点击注册按钮进行注册。登录成功后，根据用户身份显示不同的导航窗口。
初始化 <code>class LoginWindow</code> ，<code>self.bind_up()</code>绑定信号和槽函数。当登录按钮被点击时，调用 <code>sign_in</code>函数。当注册按钮被点击时，调用 <code>sign_up</code>函数。</p>
<p><code>sign_in</code>根据lineEdit中的账号和密码查询Reader表，如果查询结果为空，说明账号不存在：分为账号错误和密码错误两种情况。登录成功的同时 <code>check_manager</code>检查用户是否在manager表中，若是则接下来的导航窗口显示管理员操作按钮，否则不显示。<code>sign_up</code>首先查询注册账号是否已存在，若存在则注册失败，否则插入Reader表。</p>
<p><code>execute</code>方法建立游标执行sql语句，并返回查询结果或执行是否成功。<code>error_input</code>方法弹出错误提示框。</p>
<p>登录或注册成功之后，<code>self.close()</code>关闭登录窗口，<code>self.welcome_window.show()</code>显示导航窗口。</p>
<pre><code class="language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginWindow</span>(QMainWindow, Ui_loginWindow):
	<span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
		<span class="hljs-built_in">super</span>().__init__() <span class="hljs-comment">#初始化QMainWindows类</span>
		self.welcome_window = <span class="hljs-literal">None</span>
		self.setupUi(self)
		self.setWindowTitle(<span class="hljs-string">&#x27;图书管理系统-----PB21061224付斯珂&#x27;</span>)
		self.bind_up()
	
	<span class="hljs-keyword">def</span> <span class="hljs-title function_">bind_up</span>(<span class="hljs-params">self</span>):
		self.sign_in_button.clicked.connect(self.sign_in)
		self.sign_up_button.clicked.connect(self.sign_up)

	<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, recieve</span>):
		<span class="hljs-keyword">global</span> db
		result = []
		<span class="hljs-keyword">if</span> status == <span class="hljs-number">0</span>:
			cursor = db.cursor()
			<span class="hljs-keyword">try</span>:
				cursor.execute(self.query)
			<span class="hljs-keyword">except</span>:
				self.error_input(<span class="hljs-string">&#x27;SQL执行失败&#x27;</span>)
				db.rollback()
				<span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
			<span class="hljs-keyword">if</span> recieve:  <span class="hljs-comment"># 有查询结果返回值</span>
				result = cursor.fetchall()
			<span class="hljs-keyword">else</span>: <span class="hljs-comment"># 无查询结果返回值</span>
				result = cursor.fetchall()
				<span class="hljs-keyword">if</span>(<span class="hljs-built_in">len</span>(result) == <span class="hljs-number">0</span>): 
					result = <span class="hljs-literal">False</span>
				<span class="hljs-keyword">else</span>: result = <span class="hljs-literal">True</span>

			db.commit()
			cursor.close()

		self.last = <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-comment">#每进行一次操作需要刷新 doubleclicked item时记录的待更改值</span>
		<span class="hljs-keyword">return</span> result

	<span class="hljs-keyword">def</span> <span class="hljs-title function_">error_input</span>(<span class="hljs-params">self, err_msg</span>):
		QMessageBox.information(self, <span class="hljs-string">&quot;错误提示&quot;</span>, err_msg, QMessageBox.Yes)

	<span class="hljs-comment"># 注册</span>
	<span class="hljs-keyword">def</span> <span class="hljs-title function_">sign_up</span>(<span class="hljs-params">self</span>):
		<span class="hljs-keyword">if</span> self.lineEdit.text() == <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-keyword">or</span> self.lineEdit_2.text() == <span class="hljs-string">&#x27;&#x27;</span>:
			self.error_input(<span class="hljs-string">&#x27;输入信息不足!&#x27;</span>)
			<span class="hljs-keyword">return</span>
		self.query = <span class="hljs-string">f&quot;select * from reader where rid=<span class="hljs-subst">{self.lineEdit.text()}</span>;&quot;</span>
		exist_id = self.execute(<span class="hljs-literal">False</span>)
		<span class="hljs-keyword">if</span> exist_id: 
			self.error_input(<span class="hljs-string">&#x27;账号已存在!&#x27;</span>)
			<span class="hljs-keyword">return</span>
		<span class="hljs-comment">#确认插入reader</span>
		reply = QMessageBox.question(self, <span class="hljs-string">&#x27;确认&#x27;</span>, <span class="hljs-string">&quot;确定注册?&quot;</span>, QMessageBox.Yes | QMessageBox.No, QMessageBox.No)
		<span class="hljs-keyword">if</span> reply == QMessageBox.No:
			<span class="hljs-keyword">return</span>
		self.query = <span class="hljs-string">&#x27;insert into Reader(rid, rpassword) Values(\&#x27;{}\&#x27;, \&#x27;{}\&#x27;);&#x27;</span>.<span class="hljs-built_in">format</span>(self.lineEdit.text(), self.lineEdit_2.text())
		self.execute(<span class="hljs-literal">False</span>)
		<span class="hljs-keyword">global</span> current_user 
		current_user = ((self.lineEdit.text(), <span class="hljs-literal">None</span>),)
		QMessageBox.information(self, <span class="hljs-string">&quot;提示&quot;</span>, <span class="hljs-string">&quot;注册成功！&quot;</span>, QMessageBox.Yes)
		self.welcome_window.pushButton_4.hide()

		self.close()
		self.welcome_window.setWindowTitle(<span class="hljs-string">&quot;Welcome! &quot;</span>)
		self.welcome_window.show()

	<span class="hljs-comment"># 登录</span>
	<span class="hljs-keyword">def</span> <span class="hljs-title function_">sign_in</span>(<span class="hljs-params">self</span>):
		<span class="hljs-keyword">if</span> self.lineEdit.text() == <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-keyword">or</span> self.lineEdit_2.text() == <span class="hljs-string">&#x27;&#x27;</span>:
			self.error_input(<span class="hljs-string">&#x27;输入信息不足!&#x27;</span>)
			<span class="hljs-keyword">return</span>
		self.query = <span class="hljs-string">&#x27;select rid, rname from Reader where rid=\&#x27;{}\&#x27; and rpassword=\&#x27;{}\&#x27;;&#x27;</span>.<span class="hljs-built_in">format</span>(self.lineEdit.text(), self.lineEdit_2.text())
		<span class="hljs-keyword">global</span> current_user
		current_user = self.execute(<span class="hljs-literal">True</span>)
		<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(current_user) == <span class="hljs-number">0</span>: 
			self.query = <span class="hljs-string">&#x27;select * from Reader where rid=\&#x27;{}\&#x27;;&#x27;</span>.<span class="hljs-built_in">format</span>(self.lineEdit.text())
			rid_exist = self.execute(<span class="hljs-literal">False</span>)
			<span class="hljs-keyword">if</span> rid_exist == <span class="hljs-literal">False</span>: 
				self.error_input(<span class="hljs-string">&quot;登录失败！账号不存在&quot;</span>)
			<span class="hljs-keyword">else</span>:
				self.error_input(<span class="hljs-string">&quot;登录失败！密码错误&quot;</span>)
		<span class="hljs-keyword">else</span>: 
			<span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;登录成功！&quot;</span>)
			<span class="hljs-built_in">print</span>(current_user)
			current_user_rname = current_user[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]
		
			<span class="hljs-comment"># 登录成功后检查是否为管理员</span>
			self.check_manager()  <span class="hljs-comment"># 决定管理员操作button是否显示</span>
			<span class="hljs-comment"># 关闭登录窗口</span>
			self.close()
			<span class="hljs-comment"># 根据登录用户名显示导航（欢迎）窗口</span>
			self.welcome_window.setWindowTitle(<span class="hljs-string">&quot;Welcome! &quot;</span> + <span class="hljs-built_in">str</span>(current_user_rname))
			self.welcome_window.show()
	

	<span class="hljs-keyword">def</span> <span class="hljs-title function_">check_manager</span>(<span class="hljs-params">self</span>):
		<span class="hljs-keyword">global</span> current_user
		rid = current_user[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
		self.query = <span class="hljs-string">f&quot;select * from Manager where mid=&#x27;<span class="hljs-subst">{rid}</span>&#x27;;&quot;</span>
		is_manager = self.execute(<span class="hljs-literal">False</span>)
		<span class="hljs-keyword">if</span> is_manager:
			self.welcome_window.pushButton_4.show()
		<span class="hljs-keyword">else</span>:
			self.welcome_window.pushButton_4.hide()
</code></pre>
<h5 id="导航窗口">导航窗口</h5>
<p><code>class WelcomeWindow</code>显示四个按钮，分别跳转到四个窗口：个人信息窗口、借书窗口、还书窗口、管理员操作窗口。其他内容和其他窗口类似。</p>
<pre><code class="language-python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">bind_up</span>(<span class="hljs-params">self</span>):
    self.pushButton_1.clicked.connect(<span class="hljs-keyword">lambda</span>: self.PersonalnformationWindow.show())
    self.pushButton_2.clicked.connect(<span class="hljs-keyword">lambda</span>: self.BorrowWindow.show())
    self.pushButton_3.clicked.connect(<span class="hljs-keyword">lambda</span>: self.ReturnWindow.show())
    self.pushButton_4.clicked.connect(<span class="hljs-keyword">lambda</span>: self.ManagerWindow.show())
</code></pre>
<h5 id="个人信息窗口">个人信息窗口</h5>
<p><code>class PersonalInformationWindow</code>显示读者的个人信息，包括读者号、姓名、年龄、地址、头像。用户可以修改信息。</p>
<pre><code class="language-python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">bind_up</span>(<span class="hljs-params">self</span>):
		<span class="hljs-comment"># 当输入框中的数据改变，则修改数据库对应条目</span>
		self.lineEdit.textChanged.connect(self.change_age)
		self.lineEdit_2.textChanged.connect(self.change_address)
		self.lineEdit_3.textChanged.connect(self.change_name)
		self.lineEdit_4.textChanged.connect(self.change_rid)
		self.pushButton.clicked.connect(self.change_img)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">change_rid</span>(<span class="hljs-params">self</span>):
    <span class="hljs-keyword">global</span> current_user
    reader_ID_from = current_user[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
    reader_ID_to = self.lineEdit_4.text()
    <span class="hljs-comment"># 存储过程</span>
    self.query = <span class="hljs-string">f&quot;call updateReaderID(&#x27;<span class="hljs-subst">{reader_ID_from}</span>&#x27;, &#x27;<span class="hljs-subst">{reader_ID_to}</span>&#x27;);&quot;</span>
    self.execute(<span class="hljs-literal">False</span>)
    <span class="hljs-comment"># 修改头像文件名</span>
    <span class="hljs-keyword">if</span>(os.path.exists(<span class="hljs-string">f&quot;D:/codeConfiguration/MySQL/lab2/src/user_pics/<span class="hljs-subst">{reader_ID_to}</span>.jpg&quot;</span>) <span class="hljs-keyword">and</span> os.path.exists(<span class="hljs-string">f&quot;D:/codeConfiguration/MySQL/lab2/src/user_pics/<span class="hljs-subst">{reader_ID_from}</span>.jpg&quot;</span>)):
        os.rename(<span class="hljs-string">f&quot;D:/codeConfiguration/MySQL/lab2/src/user_pics/<span class="hljs-subst">{reader_ID_from}</span>.jpg&quot;</span>, <span class="hljs-string">f&quot;D:/codeConfiguration/MySQL/lab2/src/user_pics/<span class="hljs-subst">{reader_ID_to}</span>.jpg&quot;</span>)
    <span class="hljs-comment"># 更新current_user</span>
    current_user = ((reader_ID_to, current_user[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]),)
</code></pre>
<p>修改QMainWindow的show方法。首先布置好lineEdit的显示内容，插入头像等，最后才是显示。</p>
<pre><code class="language-python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">self</span>):
    <span class="hljs-keyword">global</span> current_user
    current_user_rid = current_user[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
    current_user_rname = current_user[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]

    self.query = <span class="hljs-string">&#x27;select age from Reader where rid=\&#x27;{}\&#x27;;&#x27;</span>.<span class="hljs-built_in">format</span>(current_user_rid)
    current_user_age = self.execute(<span class="hljs-literal">True</span>)
    current_user_age = current_user_age[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
    self.query = <span class="hljs-string">&#x27;select address from Reader where rid=\&#x27;{}\&#x27;;&#x27;</span>.<span class="hljs-built_in">format</span>(current_user_rid)
    current_user_address = self.execute(<span class="hljs-literal">True</span>)
    current_user_address = current_user_address[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]

    <span class="hljs-comment"># 查询数据库中个人信息并显示</span>
    self.lineEdit_4.setText(current_user_rid)
    self.lineEdit_3.setText(<span class="hljs-built_in">str</span>(current_user_rname))
    self.lineEdit.setText(<span class="hljs-built_in">str</span>(current_user_age))
    self.lineEdit_2.setText(<span class="hljs-built_in">str</span>(current_user_address))

    <span class="hljs-comment"># 头像显示</span>
    img_path = <span class="hljs-string">&quot;D:/codeConfiguration/MySQL/lab2/src/user_pics&quot;</span> + <span class="hljs-string">&quot;/&quot;</span>+ current_user_rid + <span class="hljs-string">&quot;.jpg&quot;</span>
    <span class="hljs-keyword">if</span>(os.path.exists(img_path)):
        self.insert_image(img_path)  <span class="hljs-comment"># 插入对应用户头像</span>
    <span class="hljs-keyword">else</span>:
        self.insert_image(self.default_img_path)  <span class="hljs-comment"># 插入默认图片</span>

    <span class="hljs-built_in">super</span>().show()
</code></pre>
<h5 id="借书和还书窗口">借书和还书窗口</h5>
<p><code>class BorrowWindow</code>根据书名关键字，<code>search_book</code>查询书籍，点击借书按钮借书（只有可借的书籍会显示借书按钮）。</p>
<pre><code class="language-python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">search_book</span>(<span class="hljs-params">self</span>):
    self.query = <span class="hljs-string">f&quot;select * from Book where bname LIKE &#x27;%<span class="hljs-subst">{self.lineEdit.text()}</span>%&#x27;;&quot;</span>
    book_info = self.execute(<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(book_info) == <span class="hljs-number">0</span>: 
        self.error_input(<span class="hljs-string">&quot;未找到相关书籍！&quot;</span>)
        <span class="hljs-keyword">return</span>
    self.tableWidget.setRowCount(<span class="hljs-number">0</span>)  <span class="hljs-comment"># 清空表格上次搜索记录</span>
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> book_info: 
        i = <span class="hljs-number">0</span>
        bstatus = <span class="hljs-string">&quot;可借&quot;</span> <span class="hljs-keyword">if</span> row[<span class="hljs-number">4</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;不可借&quot;</span>
        self.tableWidget.insertRow(i)  <span class="hljs-comment"># 尾部插入一行</span>
        <span class="hljs-keyword">if</span>(row[<span class="hljs-number">4</span>] == <span class="hljs-number">0</span>): 
            self.query = <span class="hljs-string">f&quot;select borrow_Date from Borrow where book_ID=&#x27;<span class="hljs-subst">{row[<span class="hljs-number">0</span>]}</span>&#x27; and return_Date is NULL;&quot;</span>
            borrow_Date = self.execute(<span class="hljs-literal">True</span>)
            borrow_Date = borrow_Date[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
            self.tableWidget.setItem(i, <span class="hljs-number">4</span>, QTableWidgetItem(<span class="hljs-string">f&quot;<span class="hljs-subst">{bstatus}</span> 借出日期<span class="hljs-subst">{<span class="hljs-built_in">str</span>(borrow_Date.year)}</span>-<span class="hljs-subst">{<span class="hljs-built_in">str</span>(borrow_Date.month)}</span>-<span class="hljs-subst">{<span class="hljs-built_in">str</span>(borrow_Date.day)}</span>&quot;</span>))
        <span class="hljs-keyword">else</span>: 
            self.tableWidget.setItem(i, <span class="hljs-number">4</span>, QTableWidgetItem(bstatus))
        self.tableWidget.setItem(i, <span class="hljs-number">0</span>, QTableWidgetItem(<span class="hljs-built_in">str</span>(row[<span class="hljs-number">0</span>])))  <span class="hljs-comment"># 设置该行元素</span>
        self.tableWidget.setItem(i, <span class="hljs-number">1</span>, QTableWidgetItem(<span class="hljs-built_in">str</span>(row[<span class="hljs-number">1</span>])))
        self.tableWidget.setItem(i, <span class="hljs-number">2</span>, QTableWidgetItem(<span class="hljs-built_in">str</span>(row[<span class="hljs-number">2</span>])))
        self.tableWidget.setItem(i, <span class="hljs-number">3</span>, QTableWidgetItem(<span class="hljs-built_in">str</span>(row[<span class="hljs-number">3</span>])))
        self.tableWidget.setItem(i, <span class="hljs-number">5</span>, QTableWidgetItem(<span class="hljs-built_in">str</span>(row[<span class="hljs-number">5</span>])))
        <span class="hljs-comment"># 添加借阅按钮</span>
        <span class="hljs-keyword">if</span>(row[<span class="hljs-number">4</span>]):
            borrow_buttons = self.__dict__
            borrow_buttons[<span class="hljs-string">&#x27;borrow_button_&#x27;</span> + <span class="hljs-built_in">str</span>(i)] = QPushButton(<span class="hljs-string">&#x27;借阅&#x27;</span>)
            self.tableWidget.setCellWidget(i, <span class="hljs-number">6</span>, borrow_buttons[<span class="hljs-string">&#x27;borrow_button_&#x27;</span> + <span class="hljs-built_in">str</span>(i)])  <span class="hljs-comment"># 假设你想在第8列（索引为7）添加按钮</span>
            borrow_buttons[<span class="hljs-string">&#x27;borrow_button_&#x27;</span> + <span class="hljs-built_in">str</span>(i)].clicked.connect(self.borrow_book)
        <span class="hljs-keyword">else</span> :
            self.tableWidget.setItem(i, <span class="hljs-number">6</span>, QTableWidgetItem(<span class="hljs-string">&#x27;&#x27;</span>))  <span class="hljs-comment"># 不可借时不显示按钮</span>
        i += <span class="hljs-number">1</span>
</code></pre>
<p><code>class ReturnWindow</code>还书窗口，和借书窗口类似。首先查询用户所有借书记录，未还的记录会显示还书按钮，点击还书按钮还书。</p>
<h5 id="管理员操作窗口">管理员操作窗口</h5>
<p><code>class ManagerWindow</code>管理员操作窗口，用户管理和书籍管理分别在两个tab窗口中，管理员可以删除用户（自动归还该用户未还的所有书），下架（状态为未被借的）书籍，上架书籍。</p>
<h2 id="实验与测试">实验与测试</h2>
<h4 id="依赖">依赖</h4>
<blockquote>
<p>所需的库、运行环境</p>
</blockquote>
<ul>
<li>python3</li>
<li>PyQt5</li>
<li>MySQLdb</li>
</ul>
<h4 id="部署">部署</h4>
<blockquote>
<p>代码运行步骤，建议使用命令行运行代码</p>
</blockquote>
<p>使用命令行运行代码<code>python src/backend.py</code></p>
<h4 id="实验结果">实验结果</h4>
<blockquote>
<p>如增删改查、验证存储过程、函数、触发器、文件管理
登录
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\1.png" alt="alt text">
登录失败
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\2.png" alt="alt text">
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\3.png" alt="alt text">
登陆成功，显示欢迎（导航）界面
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\4.png" alt="alt text">
个人信息界面
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\5.png" alt="alt text">
修改个人信息，如修改年龄
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\6.png" alt="alt text"></p>
</blockquote>
<p>借书界面
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\7.png" alt="alt text">
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\8.png" alt="alt text">
当前用户借阅Mysql Cookbook
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\9.png" alt="alt text">
借书成功
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\10.png" alt="alt text"></p>
<p>还书界面
所有记录
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\11.png" alt="alt text">
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\12.png" alt="alt text">
未还记录
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\13.png" alt="alt text">
归还pride and prejudice
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\14.png" alt="alt text">
未还记录减少
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\15.png" alt="alt text">
所有记录中pride and prejudice已被归还，还书日期为今天
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\16.png" alt="alt text"></p>
<p>以管理员'付斯珂'登录，管理员操作界面
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\17.png" alt="alt text">
用户管理
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\18.png" alt="alt text">
删除用户'Cloud'，自动归还该用户所有未还书籍
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\19.png" alt="alt text">
之前被'Cloud'借出的mysql cookbook状态变为可借
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\20.png" alt="alt text">
书籍管理
上架新书
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\21.png" alt="alt text">
查询发现上架成功
<img src="file:///d:\codeConfiguration\MySQL\lab2\report\image\22.png" alt="alt text"></p>
<h2 id="参考">参考</h2>
<blockquote>
<p>如前端使用的模板、引用的图片来源、第三方库的官网等等</p>
</blockquote>
<ul>
<li>PyQt5官方文档：<a href="https://doc.qt.io/qtforpython/">https://doc.qt.io/qtforpython/</a></li>
<li>qt designer：<a href="https://doc.qt.io/qt-5/qtdesigner-manual.html">https://doc.qt.io/qt-5/qtdesigner-manual.html</a></li>
</ul>

            
            
        </body>
        </html>